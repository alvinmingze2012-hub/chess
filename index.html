<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mobile FPS (Fixed)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: black;
}

#joystick {
  position: absolute;
  bottom: 20px;
  left: 20px;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
}

#stick {
  position: absolute;
  left: 40px;
  top: 40px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(0,200,255,0.8);
}
</style>
</head>

<body>

<div id="joystick">
  <div id="stick"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>

<script>
/* =========================
   BASIC THREE.JS SETUP
========================= */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x202020);

const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth / window.innerHeight,
  0.1,
  1000
);
camera.position.set(0, 1.6, 5);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

/* =========================
   LIGHTS (IMPORTANT)
========================= */
scene.add(new THREE.AmbientLight(0xffffff, 0.6));

const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
dirLight.position.set(5, 10, 5);
scene.add(dirLight);

/* =========================
   FLOOR
========================= */
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(100, 100),
  new THREE.MeshStandardMaterial({ color: 0x555555 })
);
floor.rotation.x = -Math.PI / 2;
scene.add(floor);

/* =========================
   TEST CUBE (DEBUG OBJECT)
========================= */
const cube = new THREE.Mesh(
  new THREE.BoxGeometry(),
  new THREE.MeshStandardMaterial({ color: 0xff0000 })
);
cube.position.set(0, 1, -5);
scene.add(cube);

/* =========================
   JOYSTICK LOGIC (SAFE)
========================= */
let moveX = 0;
let moveZ = 0;

const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");

let dragging = false;

joystick.addEventListener("touchstart", () => dragging = true);
joystick.addEventListener("touchend", () => {
  dragging = false;
  stick.style.left = "40px";
  stick.style.top = "40px";
  moveX = moveZ = 0;
});

joystick.addEventListener("touchmove", e => {
  if (!dragging) return;

  const rect = joystick.getBoundingClientRect();
  const touch = e.touches[0];

  let x = touch.clientX - rect.left - 60;
  let y = touch.clientY - rect.top - 60;

  const max = 40;
  x = Math.max(-max, Math.min(max, x));
  y = Math.max(-max, Math.min(max, y));

  stick.style.left = 40 + x + "px";
  stick.style.top  = 40 + y + "px";

  moveX = x / max;
  moveZ = y / max;
});

/* =========================
   ANIMATION LOOP (SAFE)
========================= */
function animate() {
  requestAnimationFrame(animate);

  // Move camera (NO NaN possible)
  camera.position.x += moveX * 0.05;
  camera.position.z += moveZ * 0.05;

  renderer.render(scene, camera);
}

animate();

/* =========================
   RESIZE FIX
========================= */
window.addEventListener("resize", () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
